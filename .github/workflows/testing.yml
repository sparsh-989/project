name: Update tsc.json with new member from CODEOWNERS

on:
  push:
    branches-ignore:
      - main
    paths:
      - 'CODEOWNERS'

jobs:
  update_tsc_json:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout current branch
      uses: actions/checkout@v2

    - name: Checkout main branch
      run: |
        git fetch origin main:main
        git checkout main

    - name: Extract username and check if it exists in tsc.json
      id: check_user
      run: |
        USERNAME=$(grep "test.txt" CODEOWNERS | awk '{print $2}' | sed 's/@//')
        REPO_NAME=$(basename `git rev-parse --show-toplevel`)
        EXISTS=$(jq '.[] | select(.github == '\"$USERNAME\"')' tsc.json)
        echo "::set-output name=username::$USERNAME"
        echo "::set-output name=repo_name::$REPO_NAME"
        echo "::set-output name=exists::$EXISTS"

    - name: Add new member to tsc.json
      if: steps.check_user.outputs.exists == ''
      run: |
        echo '{
          "name": "New Member",
          "github": "${{ steps.check_user.outputs.username }}",
          "repos": [
            "${{ steps.check_user.outputs.repo_name }}"
          ]
        }' >> tsc.json

    - name: Commit and push changes
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "your_email@example.com"
        git add tsc.json
        git commit -m "Update tsc.json with a new member from CODEOWNERS"
        git remote set-url origin "https://x-access-token:${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}@github.com/sparsh-989/project.git"
        git push origin main
