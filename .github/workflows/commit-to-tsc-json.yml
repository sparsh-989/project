name: Check Human Edits

on:
  push:
    branches:
      - main
    paths:
      - 'tsc.json'
  pull_request:
    branches:
      - main
    paths:
      - 'tsc.json'

jobs:
  check-human-edits:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: 16

      - name: Install Dependencies
        run: npm ci

      - name: Run script.js to check user type
        id: check-user-type
        run: echo "::set-output name=user_type::$(node .github/workflows/script.js ${{ github.event.pull_request.head.sha || github.sha }})"

      - name: Set is_human variable
        id: set-is-human
        run: |
          if [ ${{ steps.check-user-type.outputs.user_type }} == "The user is a human." ]; then
            echo "is_human=true" >> $GITHUB_ENV
          else
            echo "is_human=false" >> $GITHUB_ENV
          fi

      - name: Print is_human variable
        run: echo "is_human: ${{ env.is_human }}"

      - name: Get changes in tsc.json
        run: |
          git fetch origin main
          git diff origin/main tsc.json > changes.diff

      - name: Ensure only allowed changes if the user is a human
        if: ${{ env.is_human == 'true' }}
        run: |
          ALLOWED_CHANGES="twitter\|slack\|linkedin\|availableForHire"
          if grep -q -v -E "^[\+\-]( {4}$ALLOWED_CHANGES:)" changes.diff; then
            echo "Error: Only changes to twitter, slack, linkedin, and availableForHire are allowed for human users."
            exit 1
          fi
