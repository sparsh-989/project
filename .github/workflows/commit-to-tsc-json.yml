name: Check Commit Author and Display Diff

on:
  push:
    branches:
      - main
    paths:
      - 'tsc.json'

jobs:
  check-author:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v2

      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16.x'

      - name: Install dependencies
        run: npm install

      - name: Get parent commit
        id: parent-commit
        run: echo "::set-output name=parent-commit::$(git rev-parse HEAD~)"

      - name: Get diff between current and previous version of tsc.json
        id: diff-tsc-json
        env:
          PARENT_COMMIT: ${{ steps.parent-commit.outputs.parent-commit }}
        run: |
          if [[ -n "${PARENT_COMMIT}" ]]; then
            git show ${PARENT_COMMIT}:tsc.json > prev-tsc.json
            git diff --no-color prev-tsc.json tsc.json > diff.txt || true
          fi
          echo "::set-output name=diff-path::diff.txt"

      - name: Display Git diff
        if: steps.diff-tsc-json.outputs.diff-path != ''
        run: cat "${{ steps.diff-tsc-json.outputs.diff-path }}"

      - name: Run script
        env:
          COMMIT_ID: ${{ github.sha }}
        run: node .github/workflows/script.js $COMMIT_ID
